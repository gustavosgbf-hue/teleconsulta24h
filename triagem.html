<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Triagem M√©dica ¬∑ Pronto Atendimento Online</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Outfit',sans-serif;
  background:#060d0b;
  color:rgba(255,255,255,.92);
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
  min-height:100vh;
}

:root{
  --g1:#b4e05a;
  --g2:#5ee0a0;
  --dark:#060d0b;
  --card:rgba(255,255,255,.05);
  --line:rgba(255,255,255,.09);
  --muted:rgba(255,255,255,.55);
  --muted2:rgba(255,255,255,.32);
}

/* BG */
.bg-glow{
  position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 70vw 50vh at 10% 0%, rgba(180,224,90,.11) 0%,transparent 60%),
    radial-gradient(ellipse 50vw 40vh at 90% 10%,rgba(94,224,160,.09) 0%,transparent 55%);
}
.z1{position:relative;z-index:1}

/* NAV */
.nav{
  position:sticky;top:0;z-index:100;
  background:rgba(6,13,11,.75);
  backdrop-filter:blur(18px);
  border-bottom:1px solid var(--line);
  padding:13px 20px;
  display:flex;align-items:center;gap:12px;
}
.nav__brand{
  font-family:'Outfit',sans-serif;font-weight:600;font-size:.9rem;
  color:rgba(255,255,255,.9);
}
.nav__step{
  margin-left:auto;
  font-size:.72rem;font-weight:500;letter-spacing:.08em;
  color:var(--muted2);text-transform:uppercase;
}
.live-dot{
  width:7px;height:7px;border-radius:50%;background:var(--g2);flex-shrink:0;
  animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(94,224,160,.5)}
  50%{opacity:.8;box-shadow:0 0 0 5px rgba(94,224,160,0)}
}

/* SCREENS */
.screen{display:none;min-height:calc(100vh - 53px)}
.screen.active{display:flex;flex-direction:column}

/* SCREEN 1 */
#screen-terms{align-items:center;justify-content:center;padding:32px 20px;}
.terms-box{
  width:min(640px,100%);
  border:1px solid var(--line);
  border-radius:22px;
  background:rgba(255,255,255,.03);
  overflow:hidden;
}
.terms-head{padding:28px 28px 20px;border-bottom:1px solid var(--line);}
.terms-head h1{
  font-family:'Playfair Display',serif;
  font-size:1.5rem;font-weight:500;
  margin-bottom:6px;
}
.terms-head p{font-size:.82rem;color:var(--muted);font-weight:300;line-height:1.6}
.terms-scroll{
  height:320px;overflow-y:auto;
  padding:20px 28px;
  font-size:.8rem;font-weight:300;color:var(--muted);line-height:1.8;
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent;
}
.terms-scroll::-webkit-scrollbar{width:4px}
.terms-scroll::-webkit-scrollbar-track{background:transparent}
.terms-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:4px}
.terms-scroll h3{
  font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:600;
  color:rgba(255,255,255,.75);margin:16px 0 6px;
}
.terms-scroll p{margin-bottom:10px}

.terms-footer{
  padding:18px 28px 24px;
  border-top:1px solid var(--line);
  background:rgba(0,0,0,.15);
}
.terms-check{
  display:flex;align-items:flex-start;gap:12px;
  margin-bottom:16px;cursor:pointer;opacity:1;
}
.terms-check input[type=checkbox]{
  width:18px;height:18px;flex-shrink:0;margin-top:2px;
  accent-color:var(--g1);cursor:pointer;
}
.terms-check span{
  font-size:.82rem;font-weight:400;color:rgba(255,255,255,.75);line-height:1.55;
}

/* SCREEN 2 & 3 chat area */
#screen-triage, #screen-chat{
  flex-direction:column;
  height:calc(100vh - 53px);
}
.chat-area{
  flex:1;overflow-y:auto;
  padding:24px 20px;
  display:flex;flex-direction:column;gap:14px;
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent;
}
.chat-area::-webkit-scrollbar{width:3px}
.chat-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}

/* messages */
.msg{
  display:flex;gap:10px;align-items:flex-end;
  animation:msgIn .3s ease;
}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg--bot{align-self:flex-start;max-width:88%}
.msg--user{align-self:flex-end;flex-direction:row-reverse;max-width:80%}

.msg__avatar{
  width:32px;height:32px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(135deg,rgba(180,224,90,.25),rgba(94,224,160,.15));
  border:1px solid rgba(94,224,160,.25);
  display:flex;align-items:center;justify-content:center;
  font-size:.8rem;
}
.msg__bubble{
  padding:12px 16px;border-radius:18px;
  font-size:.9rem;font-weight:300;line-height:1.65;
}
.msg--bot .msg__bubble{
  background:rgba(255,255,255,.07);
  border:1px solid var(--line);
  border-bottom-left-radius:5px;
  color:rgba(255,255,255,.88);
}
.msg--user .msg__bubble{
  background:#b4e05a;
  background-image:linear-gradient(135deg,#b4e05a,#6ed49a);
  color:#051208;font-weight:500;
  border-bottom-right-radius:5px;
}

/* typing indicator */
.typing{display:flex;gap:4px;padding:14px 16px;align-items:center}
.typing span{
  width:6px;height:6px;border-radius:50%;
  background:rgba(255,255,255,.4);
  animation:typingDot 1.2s ease-in-out infinite;
}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes typingDot{
  0%,80%,100%{transform:translateY(0);opacity:.4}
  40%{transform:translateY(-5px);opacity:1}
}

/* options */
.options{display:flex;flex-wrap:wrap;gap:8px;padding:4px 0 8px;}
.opt{
  padding:9px 16px;border-radius:999px;
  border:1px solid rgba(180,224,90,.35);
  background:rgba(180,224,90,.06);
  color:rgba(255,255,255,.85);
  font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:500;
  cursor:pointer;transition:background .15s,border-color .15s,transform .1s;
}
.opt:hover{background:rgba(180,224,90,.14);border-color:rgba(180,224,90,.6);transform:translateY(-1px)}
.opt:active{transform:none}

/* input bar */
.input-bar{
  padding:12px 16px 20px;
  background:rgba(6,13,11,.8);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--line);
  display:flex;gap:10px;align-items:flex-end;
}
.input-bar textarea{
  flex:1;padding:11px 15px;border-radius:14px;
  background:rgba(255,255,255,.07);
  border:1px solid var(--line);
  color:#fff;font-family:'Outfit',sans-serif;font-size:.875rem;font-weight:300;
  resize:none;outline:none;min-height:44px;max-height:120px;
  line-height:1.5;
  transition:border-color .2s;
}
.input-bar textarea::placeholder{color:rgba(255,255,255,.3)}
.input-bar textarea:focus{border-color:rgba(94,224,160,.4)}
.send-btn{
  width:44px;height:44px;border-radius:50%;border:none;
  background-image:linear-gradient(135deg,#b4e05a,#5ee0a0);
  color:#051208;cursor:pointer;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  transition:transform .12s,box-shadow .15s;
  box-shadow:0 4px 14px rgba(180,224,90,.3);
}
.send-btn:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(180,224,90,.4)}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* progress bar */
.progress-bar{height:3px;background:var(--line);position:relative;}
.progress-fill{
  height:100%;
  background:linear-gradient(90deg,#b4e05a,#5ee0a0);
  transition:width .5s ease;
  border-radius:0 2px 2px 0;
}

/* Chat header (screen 3) */
.chat-header{
  padding:14px 20px;
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.02);
  display:flex;align-items:center;gap:12px;
}
.chat-header__avatar{
  width:38px;height:38px;border-radius:50%;
  background:linear-gradient(135deg,rgba(180,224,90,.2),rgba(94,224,160,.15));
  border:1px solid rgba(94,224,160,.3);
  display:flex;align-items:center;justify-content:center;font-size:1rem;
}
.chat-header__name{font-weight:600;font-size:.92rem}
.chat-header__status{
  font-size:.72rem;color:var(--g2);font-weight:400;margin-top:1px;
  display:flex;align-items:center;gap:5px;
}
.summary-badge{
  margin-left:auto;
  padding:6px 12px;border-radius:999px;
  border:1px solid rgba(180,224,90,.3);
  background:rgba(180,224,90,.06);
  font-size:.7rem;font-weight:500;color:var(--g1);
  cursor:pointer;
  transition:background .15s;
}
.summary-badge:hover{background:rgba(180,224,90,.12)}

/* summary panel */
.summary-panel{
  display:none;
  margin:12px 16px;
  border:1px solid rgba(180,224,90,.2);
  border-radius:16px;
  background:rgba(180,224,90,.04);
  padding:16px 18px;
  font-size:.8rem;font-weight:300;color:var(--muted);
  line-height:1.75;
  white-space:pre-wrap;
}
.summary-panel.open{display:block}
.summary-panel strong{color:rgba(255,255,255,.8);font-weight:500}

@media(max-width:480px){
  .terms-head{padding:20px 18px 16px}
  .terms-scroll{padding:16px 18px;height:260px}
  .terms-footer{padding:14px 18px 20px}
  .msg__bubble{font-size:.85rem}
}
</style>
</head>

<body>
<div class="bg-glow" aria-hidden="true"></div>

<nav class="nav z1">
  <div class="live-dot"></div>
  <span class="nav__brand">Pronto Atendimento Online</span>
  <span class="nav__step" id="nav-step">Termos de Uso</span>
</nav>

<!-- SCREEN 1 -->
<div id="screen-terms" class="screen active z1">
  <div class="terms-box">
    <div class="terms-head">
      <h1>Termos de Uso & TCLE</h1>
      <p>Leia com aten√ß√£o antes de iniciar sua triagem m√©dica online.</p>
    </div>

    <div class="terms-scroll" id="termsScroll">
      <h3>1. O que √© este servi√ßo</h3>
      <p>O Pronto Atendimento Online √© um servi√ßo de telemedicina que facilita o contato entre m√©dico e paciente, permitindo orienta√ß√£o m√©dica remota por chat, conforme a Resolu√ß√£o CFM n¬∫ 2.314/2022. O atendimento pode incluir avalia√ß√£o cl√≠nica √† dist√¢ncia, esclarecimento de d√∫vidas, orienta√ß√µes e, quando clinicamente adequado, emiss√£o de documentos m√©dicos digitais v√°lidos em territ√≥rio nacional.</p>

      <h3>2. Limita√ß√µes do servi√ßo</h3>
      <p>Este servi√ßo N√ÉO substitui pronto-atendimento presencial, emerg√™ncia ou urg√™ncia. Situa√ß√µes que envolvem dor tor√°cica intensa, falta de ar importante, desmaio, sinais de AVC, sangramento ativo ou qualquer quadro grave exigem busca imediata de atendimento presencial de urg√™ncia.</p>
      <p>A resposta do m√©dico pode levar at√© 12 horas ap√≥s o in√≠cio da triagem, pois h√° limita√ß√£o de disponibilidade. O paciente declara que compreende essa limita√ß√£o e que seu quadro n√£o √© uma emerg√™ncia.</p>

      <h3>3. Responsabilidade pelas informa√ß√µes</h3>
      <p>Voc√™ declara que todas as respostas fornecidas durante a triagem s√£o verdadeiras, completas e refletem seu quadro atual. A omiss√£o de dados relevantes ou simula√ß√£o de sintomas pode resultar em recusa de emiss√£o de documentos e interrup√ß√£o do atendimento.</p>

      <h3>4. Atestados, receitas e documentos m√©dicos</h3>
      <p>A emiss√£o de atestado, CID, afastamento laboral, prescri√ß√£o de medicamentos ou solicita√ß√£o de exames N√ÉO √â AUTOM√ÅTICA. O m√©dico s√≥ emitir√° documentos se houver justificativa cl√≠nica suficiente, dentro da √©tica e das normas do CFM. Voc√™ est√° contratando avalia√ß√£o m√©dica, n√£o "compra garantida de atestado ou receita".</p>

      <h3>5. Privacidade e LGPD</h3>
      <p>A plataforma coleta e trata dados pessoais e dados de sa√∫de (dados sens√≠veis). Esses dados s√£o utilizados exclusivamente para viabilizar o atendimento m√©dico, manter o prontu√°rio cl√≠nico e cumprir obriga√ß√µes legais e regulat√≥rias. N√£o compartilharemos dados identific√°veis com terceiros para fins publicit√°rios.</p>
      <p>O m√©dico est√° vinculado ao sigilo profissional e ao C√≥digo de √âtica M√©dica. O conte√∫do do chat integra o prontu√°rio do paciente.</p>

      <h3>6. Consentimento Livre e Esclarecido (TCLE)</h3>
      <p>Ao aceitar, voc√™ confirma que: (i) compreende a natureza do atendimento remoto e suas limita√ß√µes; (ii) concorda com o tempo de resposta de at√© 12 horas; (iii) autoriza o tratamento dos seus dados pessoais de sa√∫de para fins de presta√ß√£o do servi√ßo; (iv) reconhece que documentos m√©dicos s√≥ ser√£o emitidos com indica√ß√£o cl√≠nica; (v) compromete-se a agir com boa-f√© e veracidade.</p>

      <h3>7. Uso adequado e condutas proibidas</h3>
      <p>√â expressamente proibido: simular sintomas para obter documentos sem base cl√≠nica, alterar ou ceder a terceiros documentos m√©dicos emitidos, assediar ou coagir o m√©dico. Tentativas de fraude poder√£o ser comunicadas √†s autoridades competentes.</p>

      <h3>8. Legisla√ß√£o aplic√°vel</h3>
      <p>Estes termos s√£o regidos pelas leis brasileiras, incluindo o C√≥digo de Defesa do Consumidor, a LGPD e as resolu√ß√µes do CFM aplic√°veis √† telemedicina.</p>
    </div>

    <div class="terms-footer">
      <label class="terms-check" id="checkLabel">
        <input type="checkbox" id="termsCheck" onchange="toggleAceitar(this)"/>
        <span>Li e concordo com os Termos de Uso, Pol√≠tica de Privacidade e TCLE.</span>
      </label>

      <button id="btnAccept" onclick="iniciarTriagem()" disabled style="
        width:100%;padding:14px;border-radius:14px;border:none;
        background-color:#b4e05a;color:#051208;
        font-family:'Outfit',sans-serif;font-weight:600;font-size:.95rem;
        cursor:not-allowed;opacity:.35;
        box-shadow:0 6px 24px rgba(180,224,90,.28);
      ">Aceitar e iniciar triagem</button>
    </div>

  </div>
</div>

<!-- SCREEN 2 -->
<div id="screen-triage" class="screen z1">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
  <div class="chat-area" id="triageChat"></div>
  <div class="input-bar">
    <textarea id="triageInput" placeholder="Digite sua resposta‚Ä¶" rows="1" disabled></textarea>
    <button class="send-btn" id="triageSend" disabled aria-label="Enviar">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
</div>

<!-- SCREEN 3 -->
<div id="screen-chat" class="screen z1">
  <div class="chat-header">
    <div class="chat-header__avatar">üë®‚Äç‚öïÔ∏è</div>
    <div>
      <div class="chat-header__name">Dr. Gustavo Fonseca</div>
      <div class="chat-header__status"><span class="live-dot" style="width:6px;height:6px"></span> Online</div>
    </div>
    <button class="summary-badge" id="summaryToggle" onclick="toggleSummary()">üìã Ver anamnese</button>
  </div>

  <div class="summary-panel" id="summaryPanel"></div>
  <div class="chat-area" id="doctorChat"></div>

  <div class="input-bar">
    <textarea id="doctorInput" placeholder="Escreva sua mensagem para o m√©dico‚Ä¶" rows="1"></textarea>
    <button class="send-btn" id="doctorSend" aria-label="Enviar" onclick="sendDoctorMsg()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
import { FIREBASE_CONFIG } from './firebase-config.js';

const fbApp = initializeApp(FIREBASE_CONFIG);
const db = getFirestore(fbApp);
let consultaId = null;

// === TERMS ===
window.toggleAceitar = function(cb){
  const btn = document.getElementById('btnAccept');
  if(cb.checked){
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
  } else {
    btn.disabled = true;
    btn.style.opacity = '.35';
    btn.style.cursor = 'not-allowed';
  }
};

window.iniciarTriagem = function(){
  showScreen('triage');
  document.getElementById('nav-step').textContent = 'Triagem M√©dica';
  startTriage();
};

// === SCREEN MGMT ===
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
}

// === TRIAGE ===
const triageChat  = document.getElementById('triageChat');
const triageInput = document.getElementById('triageInput');
const triageSend  = document.getElementById('triageSend');
const progressFill = document.getElementById('progressFill');

let triageHistory = [];
let anamnesis = {};
let awaitingFreeText = false;

const SYSTEM_TRIAGE = `Voc√™ √© um assistente de triagem m√©dica de um servi√ßo de telemedicina chamado "Pronto Atendimento Online". Sua fun√ß√£o √© conduzir uma anamnese inicial estruturada em portugu√™s brasileiro, de forma emp√°tica, clara e objetiva, como uma enfermeira experiente.

FLUXO OBRIGAT√ìRIO (siga esta sequ√™ncia, adaptando conforme respostas):
1. Pe√ßa nome completo
2. Pergunte idade e sexo (pode juntar numa pergunta)
3. Pergunte a queixa principal
4. Pergunte h√° quanto tempo est√° assim e intensidade (0-10)
5. Fa√ßa perguntas de follow-up cl√≠nico relevantes para a queixa (ex: irradia√ß√£o, febre, perda de peso, trauma, fatores de melhora/piora, outros sintomas associados) ‚Äî m√°ximo 3-4 perguntas adicionais, uma por vez
6. Pergunte sobre antecedentes: doen√ßas cr√¥nicas, alergias a medicamentos, medicamentos em uso, e se mulher: gesta√ß√£o/lacta√ß√£o
7. Pergunte se precisa de atestado e/ou receita; se sim, pe√ßa ocupa√ß√£o, dias de afastamento necess√°rios e se autoriza incluir CID
8. Quando tiver todas as informa√ß√µes, responda EXATAMENTE com este JSON (sem texto antes ou depois):
{"done":true,"summary":"üìã ANAMNESE\\n\\nüë§ Identifica√ß√£o\\n‚Ä¢ Nome: [nome]\\n‚Ä¢ Idade: [idade]\\n‚Ä¢ Sexo: [sexo]\\n\\nü©∫ Queixa Principal\\n[queixa]\\n\\nüóíÔ∏è Hist√≥ria M√≥rbida Atual\\n[sintomas detalhados]\\n\\nüìå Hist√≥ria M√≥rbida Pregressa\\n‚Ä¢ Doen√ßas cr√¥nicas: []\\n‚Ä¢ Alergia a medicamentos: []\\n‚Ä¢ Medicamentos em uso: []\\n[gesta√ß√£o se aplic√°vel]\\n\\nüìÑ Documentos solicitados\\n[atestado/receita ou nenhum]"}

REGRAS:
- Fa√ßa UMA pergunta por vez
- Seja breve e direto
- Use linguagem acess√≠vel, n√£o t√©cnica
- Se a queixa indicar emerg√™ncia (dor tor√°cica intensa, falta de ar grave, sinais de AVC), oriente buscar pronto-socorro IMEDIATAMENTE e encerre
- N√£o fa√ßa diagn√≥stico, apenas colete informa√ß√µes
- M√°ximo 12 perguntas no total`;

async function callTriageAPI(userMessage){
  triageHistory.push({role:'user', content: userMessage});

  try {
    const res = await fetch('https://triagem-api.onrender.com/api/triage', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        system: SYSTEM_TRIAGE,
        messages: triageHistory
      })
    });

    const data = await res.json();
    const text = data.text || ''; // <-- vem do nosso backend
    triageHistory.push({role:'assistant', content: text});
    return text;
  } catch(e){
    return 'Desculpe, houve um erro de conex√£o. Tente novamente.';
  }
}

function addMsg(role, text, opts=[]){
  const wrap = document.createElement('div');
  wrap.className = `msg msg--${role}`;

  if(role === 'bot'){
    wrap.innerHTML = `
      <div class="msg__avatar">ü©∫</div>
      <div>
        <div class="msg__bubble">${String(text).replace(/\n/g,'<br>')}</div>
        ${opts.length ? `<div class="options">${opts.map(o=>`<button class="opt" onclick="selectOpt(${JSON.stringify(o)})">${o}</button>`).join('')}</div>` : ''}
      </div>`;
  } else {
    wrap.innerHTML = `
      <div class="msg__bubble">${text}</div>
      <div class="msg__avatar">üë§</div>`;
  }

  triageChat.appendChild(wrap);
  triageChat.scrollTop = triageChat.scrollHeight;
}

function addTyping(){
  const t = document.createElement('div');
  t.className = 'msg msg--bot';
  t.id = 'typing-indicator';
  t.innerHTML = `<div class="msg__avatar">ü©∫</div><div class="msg__bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
  triageChat.appendChild(t);
  triageChat.scrollTop = triageChat.scrollHeight;
}

function removeTyping(){
  const t = document.getElementById('typing-indicator');
  if(t) t.remove();
}

function setInputEnabled(v){
  triageInput.disabled = !v;
  triageSend.disabled = !v;
  awaitingFreeText = v;
}

function updateProgress(step, total=12){
  progressFill.style.width = `${Math.min(100, Math.round((step/total)*100))}%`;
}

let stepCount = 0;

async function botReply(userMsg){
  setInputEnabled(false);
  addTyping();

  const reply = await callTriageAPI(userMsg);

  removeTyping();
  stepCount++;
  updateProgress(stepCount);

  const jsonMatch = reply.match(/\{[\s\S]*"done"\s*:\s*true[\s\S]*\}/);
  if(jsonMatch){
    try{
      const data = JSON.parse(jsonMatch[0]);
      anamnesis.summary = data.summary;

      addMsg('bot', '‚úÖ Triagem conclu√≠da! Seu resumo foi enviado para o m√©dico. Aguarde ‚Äî ele entrar√° em contato em breve pelo chat ao lado.');
      updateProgress(12);
      setTimeout(() => finishTriage(), 1200);
      return;
    } catch(e){}
  }

  const lines = reply.split('\n').filter(l => l.trim());
  const mainText = lines.filter(l => !l.startsWith('‚Üí')).join('\n');
  const opts = lines.filter(l => l.startsWith('‚Üí')).map(l => l.replace('‚Üí','').trim());

  addMsg('bot', mainText, opts);
  setInputEnabled(true);
  triageInput.focus();
}

window.selectOpt = function(val){
  document.querySelectorAll('.opt').forEach(b => {
    b.disabled = true; b.style.opacity = '.5';
  });
  addMsg('user', val);
  botReply(val);
};

async function startTriage(){
  setInputEnabled(false);
  addTyping();

  const firstMsg = await callTriageAPI('Ol√°, acabei de aceitar os termos e gostaria de iniciar minha triagem.');
  removeTyping();
  addMsg('bot', firstMsg);

  setInputEnabled(true);
  triageInput.focus();
}

triageInput.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendTriageMsg();
  }
});
triageSend.addEventListener('click', sendTriageMsg);

function sendTriageMsg(){
  const val = triageInput.value.trim();
  if(!val || !awaitingFreeText) return;
  triageInput.value = '';
  triageInput.style.height = 'auto';
  addMsg('user', val);
  botReply(val);
}

triageInput.addEventListener('input', function(){
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// === DOCTOR CHAT ===
const doctorChat  = document.getElementById('doctorChat');
const doctorInput = document.getElementById('doctorInput');
const summaryPanel = document.getElementById('summaryPanel');

async function finishTriage(){
  showScreen('chat');
  document.getElementById('nav-step').textContent = 'Chat M√©dico';
  summaryPanel.textContent = anamnesis.summary || '';

  try {
    const ref = await addDoc(collection(db,'consultas'),{
      anamnese: anamnesis.summary || '',
      status: 'aguardando',
      criadoEm: serverTimestamp(),
      ultimaAtividade: serverTimestamp()
    });
    consultaId = ref.id;

    await addDoc(collection(db,'consultas',consultaId,'mensagens'),{
      autor:'sistema',
      texto:'üìã Triagem conclu√≠da. Anamnese dispon√≠vel no painel.',
      criadoEm: serverTimestamp()
    });

    listenDoctorMessages();
  } catch(e){
    console.error('Firebase error:', e);
  }

  addDoctorMsg('bot', `Sua triagem foi recebida com sucesso! ‚úÖ

O Dr. Gustavo j√° foi notificado e entrar√° em contato em breve. O tempo m√©dio de resposta √© de at√© 12 horas.

Se seu quadro piorar ou surgirem sinais de gravidade (falta de ar intensa, dor no peito, desmaio), procure um pronto-socorro imediatamente.`);
}

function addDoctorMsg(role, text){
  const wrap = document.createElement('div');
  wrap.className = `msg msg--${role}`;
  if(role === 'bot'){
    wrap.innerHTML = `<div class="msg__avatar">üë®‚Äç‚öïÔ∏è</div><div class="msg__bubble">${String(text).replace(/\n/g,'<br>')}</div>`;
  } else {
    wrap.innerHTML = `<div class="msg__bubble">${text}</div><div class="msg__avatar">üë§</div>`;
  }
  doctorChat.appendChild(wrap);
  doctorChat.scrollTop = doctorChat.scrollHeight;
}

function listenDoctorMessages(){
  if(!consultaId) return;
  const q = query(
    collection(db,'consultas',consultaId,'mensagens'),
    orderBy('criadoEm','asc')
  );

  onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if(change.type !== 'added') return;
      const m = change.doc.data();
      if(m.autor === 'medico'){
        addDoctorMsg('bot', m.texto || '');
      }
    });
  });
}

async function sendDoctorMsg(){
  const val = doctorInput.value.trim();
  if(!val) return;

  doctorInput.value = '';
  doctorInput.style.height = 'auto';
  addDoctorMsg('user', val);

  if(consultaId){
    try {
      await addDoc(collection(db,'consultas',consultaId,'mensagens'),{
        autor:'paciente',
        texto:val,
        criadoEm: serverTimestamp()
      });
      await updateDoc(doc(db,'consultas',consultaId),{
        ultimaAtividade: serverTimestamp()
      });
    } catch(e){
      console.error('Msg save error:',e);
    }
  }
}

doctorInput.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendDoctorMsg();
  }
});
doctorInput.addEventListener('input', function(){
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

function toggleSummary(){
  summaryPanel.classList.toggle('open');
}

// Expor fun√ß√µes usadas em onclick (por ser type="module")
window.sendDoctorMsg = sendDoctorMsg;
window.toggleSummary = toggleSummary;

</script>
</body>
</html>
