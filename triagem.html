<!doctype html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Triagem MÃ©dica Â· Pronto Atendimento Online</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Outfit',sans-serif;
  background:#060d0b;
  color:rgba(255,255,255,.92);
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
  min-height:100vh;
}

:root{
â€“g1:#b4e05a;
â€“g2:#5ee0a0;
â€“dark:#060d0b;
â€“card:rgba(255,255,255,.05);
â€“line:rgba(255,255,255,.09);
â€“muted:rgba(255,255,255,.55);
â€“muted2:rgba(255,255,255,.32);
}

/* BG */
.bg-glow{
position:fixed;inset:0;z-index:0;pointer-events:none;
background:
radial-gradient(ellipse 70vw 50vh at 10% 0%, rgba(180,224,90,.11) 0%,transparent 60%),
radial-gradient(ellipse 50vw 40vh at 90% 10%,rgba(94,224,160,.09) 0%,transparent 55%);
}

.z1{position:relative;z-index:1}

/* NAV */
.nav{
position:sticky;top:0;z-index:100;
background:rgba(6,13,11,.75);
backdrop-filter:blur(18px);
border-bottom:1px solid var(â€“line);
padding:13px 20px;
display:flex;align-items:center;gap:12px;
}
.nav__brand{
font-family:â€˜Outfitâ€™,sans-serif;font-weight:600;font-size:.9rem;
color:rgba(255,255,255,.9);
}
.nav__step{
margin-left:auto;
font-size:.72rem;font-weight:500;letter-spacing:.08em;
color:var(â€“muted2);text-transform:uppercase;
}
.live-dot{
width:7px;height:7px;border-radius:50%;background:var(â€“g2);flex-shrink:0;
animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse{
0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(94,224,160,.5)}
50%{opacity:.8;box-shadow:0 0 0 5px rgba(94,224,160,0)}
}

/* SCREENS */
.screen{display:none;min-height:calc(100vh - 53px)}
.screen.active{display:flex;flex-direction:column}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 1 Â· TERMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-terms{
align-items:center;justify-content:center;
padding:32px 20px;
}
.terms-box{
width:min(640px,100%);
border:1px solid var(â€“line);
border-radius:22px;
background:rgba(255,255,255,.03);
overflow:hidden;
}
.terms-head{
padding:28px 28px 20px;
border-bottom:1px solid var(â€“line);
}
.terms-head h1{
font-family:â€˜Playfair Displayâ€™,serif;
font-size:1.5rem;font-weight:500;
margin-bottom:6px;
}
.terms-head p{font-size:.82rem;color:var(â€“muted);font-weight:300;line-height:1.6}

.terms-scroll{
height:320px;overflow-y:auto;
padding:20px 28px;
font-size:.8rem;font-weight:300;color:var(â€“muted);line-height:1.8;
scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent;
}
.terms-scroll::-webkit-scrollbar{width:4px}
.terms-scroll::-webkit-scrollbar-track{background:transparent}
.terms-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:4px}
.terms-scroll h3{
font-family:â€˜Outfitâ€™,sans-serif;font-size:.82rem;font-weight:600;
color:rgba(255,255,255,.75);margin:16px 0 6px;
}
.terms-scroll p{margin-bottom:10px}

.terms-footer{
padding:18px 28px 24px;
border-top:1px solid var(â€“line);
background:rgba(0,0,0,.15);
}
.terms-check{
display:flex;align-items:flex-start;gap:12px;
margin-bottom:16px;cursor:pointer;
}
.terms-check input[type=checkbox]{
width:18px;height:18px;flex-shrink:0;margin-top:2px;
accent-color:var(â€“g1);cursor:pointer;
}
.terms-check span{
font-size:.82rem;font-weight:400;color:rgba(255,255,255,.75);line-height:1.55;
}
.terms-scroll-hint{
font-size:.72rem;color:var(â€“muted2);text-align:center;
margin-bottom:12px;
}
.btn-accept{
width:100%;padding:14px;border-radius:14px;border:none;
background-color:#b4e05a;
background-image:-webkit-linear-gradient(135deg,#b4e05a,#5ee0a0);
background-image:linear-gradient(135deg,#b4e05a,#5ee0a0);
-webkit-appearance:none;appearance:none;
color:#051208;font-family:â€˜Outfitâ€™,sans-serif;font-weight:600;font-size:.95rem;
cursor:pointer;transition:transform .12s,box-shadow .2s;
box-shadow:0 6px 24px rgba(180,224,90,.28);
opacity:.4;pointer-events:none;
}
.btn-accept.enabled{opacity:1;pointer-events:auto}
.btn-accept.enabled:hover{transform:translateY(-1px);box-shadow:0 10px 30px rgba(180,224,90,.36)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 2 Â· TRIAGE CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-triage{
flex-direction:column;
height:calc(100vh - 53px);
}
.chat-area{
flex:1;overflow-y:auto;
padding:24px 20px;
display:flex;flex-direction:column;gap:14px;
scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent;
}
.chat-area::-webkit-scrollbar{width:3px}
.chat-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}

/* messages */
.msg{
display:flex;gap:10px;align-items:flex-end;
animation:msgIn .3s ease;
}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msgâ€“bot{align-self:flex-start;max-width:88%}
.msgâ€“user{align-self:flex-end;flex-direction:row-reverse;max-width:80%}

.msg__avatar{
width:32px;height:32px;border-radius:50%;flex-shrink:0;
background:linear-gradient(135deg,rgba(180,224,90,.25),rgba(94,224,160,.15));
border:1px solid rgba(94,224,160,.25);
display:flex;align-items:center;justify-content:center;
font-size:.8rem;
}
.msg__bubble{
padding:12px 16px;border-radius:18px;
font-size:.9rem;font-weight:300;line-height:1.65;
}
.msgâ€“bot .msg__bubble{
background:rgba(255,255,255,.07);
border:1px solid var(â€“line);
border-bottom-left-radius:5px;
color:rgba(255,255,255,.88);
}
.msgâ€“user .msg__bubble{
background:#b4e05a;
background-image:-webkit-linear-gradient(135deg,#b4e05a,#6ed49a);
background-image:linear-gradient(135deg,#b4e05a,#6ed49a);
color:#051208;font-weight:500;
border-bottom-right-radius:5px;
}

/* typing indicator */
.typing{display:flex;gap:4px;padding:14px 16px;align-items:center}
.typing span{
width:6px;height:6px;border-radius:50%;
background:rgba(255,255,255,.4);
animation:typingDot 1.2s ease-in-out infinite;
}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes typingDot{
0%,80%,100%{transform:translateY(0);opacity:.4}
40%{transform:translateY(-5px);opacity:1}
}

/* options */
.options{
display:flex;flex-wrap:wrap;gap:8px;
padding:4px 0 8px;
}
.opt{
padding:9px 16px;border-radius:999px;
border:1px solid rgba(180,224,90,.35);
background:rgba(180,224,90,.06);
color:rgba(255,255,255,.85);
font-family:â€˜Outfitâ€™,sans-serif;font-size:.82rem;font-weight:500;
cursor:pointer;transition:background .15s,border-color .15s,transform .1s;
-webkit-appearance:none;appearance:none;
}
.opt:hover{background:rgba(180,224,90,.14);border-color:rgba(180,224,90,.6);transform:translateY(-1px)}
.opt:active{transform:none}

/* input bar */
.input-bar{
padding:12px 16px 20px;
background:rgba(6,13,11,.8);
backdrop-filter:blur(12px);
border-top:1px solid var(â€“line);
display:flex;gap:10px;align-items:flex-end;
}
.input-bar textarea{
flex:1;padding:11px 15px;border-radius:14px;
background:rgba(255,255,255,.07);
border:1px solid var(â€“line);
color:#fff;font-family:â€˜Outfitâ€™,sans-serif;font-size:.875rem;font-weight:300;
resize:none;outline:none;min-height:44px;max-height:120px;
line-height:1.5;
transition:border-color .2s;
-webkit-appearance:none;
}
.input-bar textarea::placeholder{color:rgba(255,255,255,.3)}
.input-bar textarea:focus{border-color:rgba(94,224,160,.4)}
.send-btn{
width:44px;height:44px;border-radius:50%;border:none;
background-color:#b4e05a;
background-image:-webkit-linear-gradient(135deg,#b4e05a,#5ee0a0);
background-image:linear-gradient(135deg,#b4e05a,#5ee0a0);
-webkit-appearance:none;appearance:none;
color:#051208;cursor:pointer;flex-shrink:0;
display:flex;align-items:center;justify-content:center;
transition:transform .12s,box-shadow .15s;
box-shadow:0 4px 14px rgba(180,224,90,.3);
}
.send-btn:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(180,224,90,.4)}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* progress bar */
.progress-bar{
height:3px;background:var(â€“line);
position:relative;
}
.progress-fill{
height:100%;
background:linear-gradient(90deg,#b4e05a,#5ee0a0);
transition:width .5s ease;
border-radius:0 2px 2px 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCREEN 3 Â· DOCTOR CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-chat{
flex-direction:column;
height:calc(100vh - 53px);
}
.chat-header{
padding:14px 20px;
border-bottom:1px solid var(â€“line);
background:rgba(255,255,255,.02);
display:flex;align-items:center;gap:12px;
}
.chat-header__avatar{
width:38px;height:38px;border-radius:50%;
background:linear-gradient(135deg,rgba(180,224,90,.2),rgba(94,224,160,.15));
border:1px solid rgba(94,224,160,.3);
display:flex;align-items:center;justify-content:center;font-size:1rem;
}
.chat-header__name{font-weight:600;font-size:.92rem}
.chat-header__status{
font-size:.72rem;color:var(â€“g2);font-weight:400;margin-top:1px;
display:flex;align-items:center;gap:5px;
}
.summary-badge{
margin-left:auto;
padding:6px 12px;border-radius:999px;
border:1px solid rgba(180,224,90,.3);
background:rgba(180,224,90,.06);
font-size:.7rem;font-weight:500;color:var(â€“g1);
cursor:pointer;
-webkit-appearance:none;appearance:none;
transition:background .15s;
}
.summary-badge:hover{background:rgba(180,224,90,.12)}

/* summary panel */
.summary-panel{
display:none;
margin:12px 16px;
border:1px solid rgba(180,224,90,.2);
border-radius:16px;
background:rgba(180,224,90,.04);
padding:16px 18px;
font-size:.8rem;font-weight:300;color:var(â€“muted);
line-height:1.75;
white-space:pre-wrap;
}
.summary-panel.open{display:block}
.summary-panel strong{color:rgba(255,255,255,.8);font-weight:500}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:480px){
.terms-head{padding:20px 18px 16px}
.terms-scroll{padding:16px 18px;height:260px}
.terms-footer{padding:14px 18px 20px}
.msg__bubble{font-size:.85rem}
}
</style>

</head>
<body>

<div class="bg-glow" aria-hidden="true"></div>

<!-- NAV -->

<nav class="nav z1">
  <div class="live-dot"></div>
  <span class="nav__brand">Pronto Atendimento Online</span>
  <span class="nav__step" id="nav-step">Termos de Uso</span>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN 1: TERMS â•â•â•â•â•â•â•â•â•â•â• -->

<div id="screen-terms" class="screen active z1">
  <div class="terms-box">
    <div class="terms-head">
      <h1>Termos de Uso & TCLE</h1>
      <p>Leia com atenÃ§Ã£o antes de iniciar sua triagem mÃ©dica online.</p>
    </div>

```
<div class="terms-scroll" id="termsScroll">
  <h3>1. O que Ã© este serviÃ§o</h3>
  <p>O Pronto Atendimento Online Ã© um serviÃ§o de telemedicina que facilita o contato entre mÃ©dico e paciente, permitindo orientaÃ§Ã£o mÃ©dica remota por chat, conforme a ResoluÃ§Ã£o CFM nÂº 2.314/2022. O atendimento pode incluir avaliaÃ§Ã£o clÃ­nica Ã  distÃ¢ncia, esclarecimento de dÃºvidas, orientaÃ§Ãµes e, quando clinicamente adequado, emissÃ£o de documentos mÃ©dicos digitais vÃ¡lidos em territÃ³rio nacional.</p>

  <h3>2. LimitaÃ§Ãµes do serviÃ§o</h3>
  <p>Este serviÃ§o NÃƒO substitui pronto-atendimento presencial, emergÃªncia ou urgÃªncia. SituaÃ§Ãµes que envolvem dor torÃ¡cica intensa, falta de ar importante, desmaio, sinais de AVC, sangramento ativo ou qualquer quadro grave exigem busca imediata de atendimento presencial de urgÃªncia.</p>
  <p>A resposta do mÃ©dico pode levar atÃ© 12 horas apÃ³s o inÃ­cio da triagem, pois hÃ¡ limitaÃ§Ã£o de disponibilidade. O paciente declara que compreende essa limitaÃ§Ã£o e que seu quadro nÃ£o Ã© uma emergÃªncia.</p>

  <h3>3. Responsabilidade pelas informaÃ§Ãµes</h3>
  <p>VocÃª declara que todas as respostas fornecidas durante a triagem sÃ£o verdadeiras, completas e refletem seu quadro atual. A omissÃ£o de dados relevantes ou simulaÃ§Ã£o de sintomas pode resultar em recusa de emissÃ£o de documentos e interrupÃ§Ã£o do atendimento.</p>

  <h3>4. Atestados, receitas e documentos mÃ©dicos</h3>
  <p>A emissÃ£o de atestado, CID, afastamento laboral, prescriÃ§Ã£o de medicamentos ou solicitaÃ§Ã£o de exames NÃƒO Ã‰ AUTOMÃTICA. O mÃ©dico sÃ³ emitirÃ¡ documentos se houver justificativa clÃ­nica suficiente, dentro da Ã©tica e das normas do CFM. VocÃª estÃ¡ contratando avaliaÃ§Ã£o mÃ©dica, nÃ£o "compra garantida de atestado ou receita".</p>

  <h3>5. Privacidade e LGPD</h3>
  <p>A plataforma coleta e trata dados pessoais e dados de saÃºde (dados sensÃ­veis). Esses dados sÃ£o utilizados exclusivamente para viabilizar o atendimento mÃ©dico, manter o prontuÃ¡rio clÃ­nico e cumprir obrigaÃ§Ãµes legais e regulatÃ³rias. NÃ£o compartilharemos dados identificÃ¡veis com terceiros para fins publicitÃ¡rios.</p>
  <p>O mÃ©dico estÃ¡ vinculado ao sigilo profissional e ao CÃ³digo de Ã‰tica MÃ©dica. O conteÃºdo do chat integra o prontuÃ¡rio do paciente.</p>

  <h3>6. Consentimento Livre e Esclarecido (TCLE)</h3>
  <p>Ao aceitar, vocÃª confirma que: (i) compreende a natureza do atendimento remoto e suas limitaÃ§Ãµes; (ii) concorda com o tempo de resposta de atÃ© 12 horas; (iii) autoriza o tratamento dos seus dados pessoais de saÃºde para fins de prestaÃ§Ã£o do serviÃ§o; (iv) reconhece que documentos mÃ©dicos sÃ³ serÃ£o emitidos com indicaÃ§Ã£o clÃ­nica; (v) compromete-se a agir com boa-fÃ© e veracidade.</p>

  <h3>7. Uso adequado e condutas proibidas</h3>
  <p>Ã‰ expressamente proibido: simular sintomas para obter documentos sem base clÃ­nica, alterar ou ceder a terceiros documentos mÃ©dicos emitidos, assediar ou coagir o mÃ©dico. Tentativas de fraude poderÃ£o ser comunicadas Ã s autoridades competentes.</p>

  <h3>8. LegislaÃ§Ã£o aplicÃ¡vel</h3>
  <p>Estes termos sÃ£o regidos pelas leis brasileiras, incluindo o CÃ³digo de Defesa do Consumidor, a LGPD e as resoluÃ§Ãµes do CFM aplicÃ¡veis Ã  telemedicina.</p>
</div>

<div class="terms-footer">
  <p class="terms-scroll-hint" id="scrollHint">â†“ Role atÃ© o final para habilitar o aceite</p>
  <label class="terms-check" id="checkLabel" style="opacity:.4;pointer-events:none">
    <input type="checkbox" id="termsCheck" disabled/>
    <span>Li e concordo com os Termos de Uso, a PolÃ­tica de Privacidade e o Termo de Consentimento Livre e Esclarecido (TCLE) para teleatendimento.</span>
  </label>
  <button class="btn-accept" id="btnAccept" disabled>Aceitar e iniciar triagem â†’</button>
</div>
```

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN 2: TRIAGE â•â•â•â•â•â•â•â•â•â•â• -->

<div id="screen-triage" class="screen z1">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
  <div class="chat-area" id="triageChat"></div>
  <div class="input-bar">
    <textarea id="triageInput" placeholder="Digite sua respostaâ€¦" rows="1" disabled></textarea>
    <button class="send-btn" id="triageSend" disabled aria-label="Enviar">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREEN 3: DOCTOR CHAT â•â•â•â•â•â•â•â•â•â•â• -->

<div id="screen-chat" class="screen z1">
  <div class="chat-header">
    <div class="chat-header__avatar">ğŸ‘¨â€âš•ï¸</div>
    <div>
      <div class="chat-header__name">Dr. Gustavo Fonseca</div>
      <div class="chat-header__status"><span class="live-dot" style="width:6px;height:6px"></span> Online</div>
    </div>
    <button class="summary-badge" id="summaryToggle" onclick="toggleSummary()">ğŸ“‹ Ver anamnese</button>
  </div>
  <div class="summary-panel" id="summaryPanel"></div>
  <div class="chat-area" id="doctorChat"></div>
  <div class="input-bar">
    <textarea id="doctorInput" placeholder="Escreva sua mensagem para o mÃ©dicoâ€¦" rows="1"></textarea>
    <button class="send-btn" id="doctorSend" aria-label="Enviar" onclick="sendDoctorMsg()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
</div>

<script type="module">
import { initializeApp }   from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
import { FIREBASE_CONFIG }  from './firebase-config.js';

const fbApp = initializeApp(FIREBASE_CONFIG);
const db    = getFirestore(fbApp);
let consultaId = null; // Firebase doc ID for this consult

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAVE DA API â€” substitua pelo seu valor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_KEY = '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';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TERMS SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const termsScroll = document.getElementById('termsScroll');
const termsCheck  = document.getElementById('termsCheck');
const checkLabel  = document.getElementById('checkLabel');
const btnAccept   = document.getElementById('btnAccept');
const scrollHint  = document.getElementById('scrollHint');

termsScroll.addEventListener('scroll', () => {
  const scrolled = termsScroll.scrollTop + termsScroll.clientHeight >= termsScroll.scrollHeight - 20;
  if(scrolled){
    checkLabel.style.opacity = '1';
    checkLabel.style.pointerEvents = 'auto';
    termsCheck.disabled = false;
    scrollHint.style.display = 'none';
  }
});

termsCheck.addEventListener('change', () => {
  if(termsCheck.checked){
    btnAccept.classList.add('enabled');
    btnAccept.disabled = false;
  } else {
    btnAccept.classList.remove('enabled');
    btnAccept.disabled = true;
  }
});

btnAccept.addEventListener('click', () => {
  showScreen('triage');
  document.getElementById('nav-step').textContent = 'Triagem MÃ©dica';
  startTriage();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIAGE CHAT ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const triageChat  = document.getElementById('triageChat');
const triageInput = document.getElementById('triageInput');
const triageSend  = document.getElementById('triageSend');
const progressFill = document.getElementById('progressFill');

let triageHistory = [];    // messages sent to API
let anamnesis = {};        // collected data
let awaitingFreeText = false;
let triageDone = false;

// System prompt for triage AI
const SYSTEM_TRIAGE = `VocÃª Ã© um assistente de triagem mÃ©dica de um serviÃ§o de telemedicina chamado "Pronto Atendimento Online". Sua funÃ§Ã£o Ã© conduzir uma anamnese inicial estruturada em portuguÃªs brasileiro, de forma empÃ¡tica, clara e objetiva, como uma enfermeira experiente.

FLUXO OBRIGATÃ“RIO (siga esta sequÃªncia, adaptando conforme respostas):
1. PeÃ§a nome completo
2. Pergunte idade e sexo (pode juntar numa pergunta)
3. Pergunte a queixa principal
4. Pergunte hÃ¡ quanto tempo estÃ¡ assim e intensidade (0-10)
5. FaÃ§a perguntas de follow-up clÃ­nico relevantes para a queixa (ex: irradiaÃ§Ã£o, febre, perda de peso, trauma, fatores de melhora/piora, outros sintomas associados) â€” mÃ¡ximo 3-4 perguntas adicionais, uma por vez
6. Pergunte sobre antecedentes: doenÃ§as crÃ´nicas, alergias a medicamentos, medicamentos em uso, e se mulher: gestaÃ§Ã£o/lactaÃ§Ã£o
7. Pergunte se precisa de atestado e/ou receita; se sim, peÃ§a ocupaÃ§Ã£o, dias de afastamento necessÃ¡rios e se autoriza incluir CID
8. Quando tiver todas as informaÃ§Ãµes, responda EXATAMENTE com este JSON (sem texto antes ou depois):
{"done":true,"summary":"ğŸ“‹ ANAMNESE\n\nğŸ‘¤ IdentificaÃ§Ã£o\nâ€¢ Nome: [nome]\nâ€¢ Idade: [idade]\nâ€¢ Sexo: [sexo]\n\nğŸ©º Queixa Principal\n[queixa]\n\nğŸ—’ï¸ HistÃ³ria MÃ³rbida Atual\n[sintomas detalhados]\n\nğŸ“Œ HistÃ³ria MÃ³rbida Pregressa\nâ€¢ DoenÃ§as crÃ´nicas: []\nâ€¢ Alergia a medicamentos: []\nâ€¢ Medicamentos em uso: []\n[gestaÃ§Ã£o se aplicÃ¡vel]\n\nğŸ“„ Documentos solicitados\n[atestado/receita ou nenhum]"}

REGRAS:
- FaÃ§a UMA pergunta por vez
- Seja breve e direto
- Use linguagem acessÃ­vel, nÃ£o tÃ©cnica
- Se a queixa indicar emergÃªncia (dor torÃ¡cica intensa, falta de ar grave, sinais de AVC), oriente buscar pronto-socorro IMEDIATAMENTE e encerre
- NÃ£o faÃ§a diagnÃ³stico, apenas colete informaÃ§Ãµes
- MÃ¡ximo 12 perguntas no total`;

async function callTriageAPI(userMessage){
  triageHistory.push({role:'user', content: userMessage});
  
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': API_KEY,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system: SYSTEM_TRIAGE,
        messages: triageHistory
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || '';
    triageHistory.push({role:'assistant', content: text});
    return text;
  } catch(e){
    return 'Desculpe, houve um erro de conexÃ£o. Tente novamente.';
  }
}

function addMsg(role, text, opts=[]){
  const wrap = document.createElement('div');
  wrap.className = `msg msg--${role}`;
  
  if(role === 'bot'){
    wrap.innerHTML = `
      <div class="msg__avatar">ğŸ©º</div>
      <div>
        <div class="msg__bubble">${text.replace(/\n/g,'<br>')}</div>
        ${opts.length ? `<div class="options">${opts.map(o=>`<button class="opt" onclick="selectOpt('${o}')">${o}</button>`).join('')}</div>` : ''}
      </div>`;
  } else {
    wrap.innerHTML = `
      <div class="msg__bubble">${text}</div>
      <div class="msg__avatar">ğŸ‘¤</div>`;
  }
  triageChat.appendChild(wrap);
  triageChat.scrollTop = triageChat.scrollHeight;
}

function addTyping(){
  const t = document.createElement('div');
  t.className = 'msg msg--bot';
  t.id = 'typing-indicator';
  t.innerHTML = `<div class="msg__avatar">ğŸ©º</div><div class="msg__bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
  triageChat.appendChild(t);
  triageChat.scrollTop = triageChat.scrollHeight;
  return t;
}

function removeTyping(){
  const t = document.getElementById('typing-indicator');
  if(t) t.remove();
}

function setInputEnabled(v){
  triageInput.disabled = !v;
  triageSend.disabled = !v;
  awaitingFreeText = v;
}

function updateProgress(step, total=12){
  progressFill.style.width = `${Math.min(100, Math.round((step/total)*100))}%`;
}

let stepCount = 0;
async function botReply(userMsg){
  setInputEnabled(false);
  addTyping();
  
  const reply = await callTriageAPI(userMsg);
  removeTyping();
  stepCount++;
  updateProgress(stepCount);

  // Check if triage is done
  const jsonMatch = reply.match(/\{[\s\S]*"done"\s*:\s*true[\s\S]*\}/);
  if(jsonMatch){
    try{
      const data = JSON.parse(jsonMatch[0]);
      anamnesis.summary = data.summary;
      triageDone = true;
      addMsg('bot', 'âœ… Triagem concluÃ­da! Seu resumo foi enviado para o mÃ©dico. Aguarde â€” ele entrarÃ¡ em contato em breve pelo chat ao lado.');
      updateProgress(12);
      setTimeout(() => finishTriage(), 2200);
      return;
    } catch(e){}
  }

  // Parse reply for quick-reply options
  const lines = reply.split('\n').filter(l => l.trim());
  const mainText = lines.filter(l => !l.startsWith('â†’')).join('\n');
  const opts = lines.filter(l => l.startsWith('â†’')).map(l => l.replace('â†’','').trim());
  
  addMsg('bot', mainText, opts);
  setInputEnabled(true);
  triageInput.focus();
}

function selectOpt(val){
  document.querySelectorAll('.opt').forEach(b => {
    b.disabled = true; b.style.opacity = '.5';
  });
  addMsg('user', val);
  botReply(val);
}

async function startTriage(){
  setInputEnabled(false);
  addTyping();
  
  // First message - no user input yet
  const firstMsg = await callTriageAPI('OlÃ¡, acabei de aceitar os termos e gostaria de iniciar minha triagem.');
  removeTyping();
  addMsg('bot', firstMsg);
  setInputEnabled(true);
  triageInput.focus();
}

// Send on Enter
triageInput.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendTriageMsg();
  }
});
triageSend.addEventListener('click', sendTriageMsg);

function sendTriageMsg(){
  const val = triageInput.value.trim();
  if(!val || !awaitingFreeText) return;
  triageInput.value = '';
  triageInput.style.height = 'auto';
  addMsg('user', val);
  botReply(val);
}

// Auto-resize textarea
triageInput.addEventListener('input', function(){
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCTOR CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const doctorChat  = document.getElementById('doctorChat');
const doctorInput = document.getElementById('doctorInput');
const summaryPanel = document.getElementById('summaryPanel');

let doctorHistory = [];

const SYSTEM_DOCTOR = `VocÃª Ã© o Dr. Gustavo Fonseca, mÃ©dico generalista atendendo por chat em uma plataforma de telemedicina. VocÃª recebeu a anamnese abaixo de um paciente e agora conduz o atendimento pelo chat.

Seu estilo:
- Humano, empÃ¡tico, direto e claro
- Usa linguagem acessÃ­vel, sem jargÃ£o desnecessÃ¡rio
- Faz perguntas quando precisa de informaÃ§Ã£o adicional
- Orienta sobre prÃ³ximos passos, sinais de alerta e quando buscar emergÃªncia presencial
- Se clinicamente indicado, informa que pode emitir atestado/receita e solicita informaÃ§Ãµes adicionais necessÃ¡rias
- NÃƒO faz diagnÃ³sticos definitivos sem exame fÃ­sico; orienta de forma responsÃ¡vel
- Se houver sinal de emergÃªncia, orienta ir ao pronto-socorro imediatamente`;

async function callDoctorAPI(userMsg){
  doctorHistory.push({role:'user', content: userMsg});
  try{
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system: SYSTEM_DOCTOR + '\n\nANAMNESE DO PACIENTE:\n' + (anamnesis.summary||''),
        messages: doctorHistory
      })
    });
    const data = await res.json();
    const text = data.content?.[0]?.text || '';
    doctorHistory.push({role:'assistant', content: text});
    return text;
  } catch(e){
    return 'Erro de conexÃ£o. Tente novamente.';
  }
}

function addDoctorMsg(role, text){
  const wrap = document.createElement('div');
  wrap.className = `msg msg--${role}`;
  if(role === 'bot'){
    wrap.innerHTML = `<div class="msg__avatar">ğŸ‘¨â€âš•ï¸</div><div class="msg__bubble">${text.replace(/\n/g,'<br>')}</div>`;
  } else {
    wrap.innerHTML = `<div class="msg__bubble">${text}</div><div class="msg__avatar">ğŸ‘¤</div>`;
  }
  doctorChat.appendChild(wrap);
  doctorChat.scrollTop = doctorChat.scrollHeight;
}

function addDoctorTyping(){
  const t = document.createElement('div');
  t.className = 'msg msg--bot';
  t.id = 'doc-typing';
  t.innerHTML = `<div class="msg__avatar">ğŸ‘¨â€âš•ï¸</div><div class="msg__bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
  doctorChat.appendChild(t);
  doctorChat.scrollTop = doctorChat.scrollHeight;
}

async function finishTriage(){
  showScreen('chat');
  document.getElementById('nav-step').textContent = 'Chat MÃ©dico';
  summaryPanel.textContent = anamnesis.summary || '';

  // Save consult to Firebase
  try {
    const ref = await addDoc(collection(db,'consultas'),{
      nome:          anamnesis.nome   || '',
      idade:         anamnesis.idade  || '',
      sexo:          anamnesis.sexo   || '',
      queixa:        anamnesis.queixa || '',
      anamnese:      anamnesis.summary || '',
      precisaAtestado: /atestado/i.test(anamnesis.summary||''),
      precisaReceita:  /receita/i.test(anamnesis.summary||''),
      status:        'aguardando',
      criadoEm:      serverTimestamp(),
      ultimaAtividade: serverTimestamp()
    });
    consultaId = ref.id;

    // Save triage summary as first system message
    await addDoc(collection(db,'consultas',consultaId,'mensagens'),{
      autor:'sistema',
      texto:'ğŸ“‹ Triagem concluÃ­da. Anamnese disponÃ­vel no painel.',
      criadoEm: serverTimestamp()
    });

    // Listen for doctor messages in real time
    listenDoctorMessages();
  } catch(e){
    console.error('Firebase error:', e);
  }

  // Show waiting message
  addDoctorMsg('bot', 'Sua triagem foi recebida com sucesso! âœ…

O Dr. Gustavo jÃ¡ foi notificado e entrarÃ¡ em contato em breve. O tempo mÃ©dio de resposta Ã© de atÃ© 12 horas.

Se seu quadro piorar ou surgirem sinais de gravidade (falta de ar intensa, dor no peito, desmaio), procure um pronto-socorro imediatamente.');
}

function listenDoctorMessages(){
  if(!consultaId) return;
  const q = query(
    collection(db,'consultas',consultaId,'mensagens'),
    orderBy('criadoEm','asc')
  );
  onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if(change.type !== 'added') return;
      const m = change.doc.data();
      if(m.autor === 'medico'){
        addDoctorMsg('bot', m.texto || '');
      }
    });
  });
}

async function sendDoctorMsg(){
  const val = doctorInput.value.trim();
  if(!val) return;
  doctorInput.value = '';
  doctorInput.style.height = 'auto';
  addDoctorMsg('user', val);

  // Save to Firebase
  if(consultaId){
    try {
      await addDoc(collection(db,'consultas',consultaId,'mensagens'),{
        autor:'paciente',
        texto:val,
        criadoEm: serverTimestamp()
      });
      await updateDoc(doc(db,'consultas',consultaId),{
        ultimaAtividade: serverTimestamp()
      });
    } catch(e){ console.error('Msg save error:',e); }
  }
}

doctorInput.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendDoctorMsg(); }
});
doctorInput.addEventListener('input', function(){
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

function toggleSummary(){
  summaryPanel.classList.toggle('open');
}
</script>

</body>
</html>
